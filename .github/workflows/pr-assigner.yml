name: ğŸ‘¤ PR ìë™ í• ë‹¹

on:
  pull_request:
    types: [opened, reopened]

jobs:
  assign-pr:
    name: PR ìë™ í• ë‹¹
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: PR ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          
          // ê¸°ë³¸ í• ë‹¹ì ì„¤ì • (ì €ì¥ì†Œ ì†Œìœ ì ë˜ëŠ” ë©”ì¸ ë©”ì¸í…Œì´ë„ˆ)
          const defaultAssignees = [owner];
          
          // PRì˜ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
          const files = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: prNumber
          });
          
          // íŒŒì¼ ê²½ë¡œë³„ ë‹´ë‹¹ì ë§¤í•‘
          const codeOwners = {
            'backend/': ['backend-team', owner],
            'frontend/': ['frontend-team', owner],
            'docs/': ['docs-team', owner],
            '.github/': ['devops-team', owner],
            'tests/': ['qa-team', owner]
          };
          
          let assignees = new Set(defaultAssignees);
          
          // ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹´ë‹¹ì ê²°ì •
          files.data.forEach(file => {
            const filePath = file.filename;
            
            for (const [path, owners] of Object.entries(codeOwners)) {
              if (filePath.startsWith(path)) {
                owners.forEach(owner => assignees.add(owner));
              }
            }
          });
          
          // ì‘ì„±ìëŠ” í• ë‹¹ìì—ì„œ ì œì™¸
          assignees.delete(author);
          
          const finalAssignees = Array.from(assignees).slice(0, 3); // ìµœëŒ€ 3ëª…ê¹Œì§€ í• ë‹¹
          
          if (finalAssignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: prNumber,
                assignees: finalAssignees
              });
              
              console.log(`âœ… PR #${prNumber}ì— í• ë‹¹ì ì¶”ê°€ ì™„ë£Œ: ${finalAssignees.join(', ')}`);
              
              // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
              const comment = `## ğŸ‘¥ ë‹´ë‹¹ì ìë™ í• ë‹¹ ì™„ë£Œ

              ë‹¤ìŒ ë‹´ë‹¹ìë“¤ì´ ì´ PRì„ ê²€í† í•  ì˜ˆì •ì…ë‹ˆë‹¤:
              ${finalAssignees.map(assignee => `- @${assignee}`).join('\n')}
              
              **í• ë‹¹ ê·¼ê±°:**
              - ê¸°ë³¸ ë©”ì¸í…Œì´ë„ˆ: @${owner}
              ${files.data.map(file => {
                for (const [path, owners] of Object.entries(codeOwners)) {
                  if (file.filename.startsWith(path)) {
                    return `- \`${file.filename}\`: ${path} ì˜ì—­ ë‹´ë‹¹ì`;
                  }
                }
                return null;
              }).filter(Boolean).slice(0, 3).join('\n')}
              
              ---
              _ìë™ìœ¼ë¡œ í• ë‹¹ëœ ë‹´ë‹¹ìì…ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤._`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: comment
              });
              
            } catch (error) {
              console.log(`âš ï¸ ì¼ë¶€ ì‚¬ìš©ìë¥¼ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
              
              // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ í• ë‹¹ìë§Œ í• ë‹¹ ì‹œë„
              try {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: prNumber,
                  assignees: [owner]
                });
              } catch (fallbackError) {
                console.log(`âŒ ê¸°ë³¸ í• ë‹¹ì í• ë‹¹ ì‹¤íŒ¨: ${fallbackError.message}`);
              }
            }
          }

  assign-reviewers:
    name: ë¦¬ë·°ì–´ ìë™ í• ë‹¹
    runs-on: ubuntu-latest
    
    steps:
    - name: ë¦¬ë·°ì–´ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          
          // ê°€ëŠ¥í•œ ë¦¬ë·°ì–´ ëª©ë¡ (ì €ì¥ì†Œì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          const possibleReviewers = [owner];
          
          // ì‘ì„±ì ì œì™¸
          const reviewers = possibleReviewers.filter(reviewer => reviewer !== author);
          
          if (reviewers.length > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: reviewers.slice(0, 2) // ìµœëŒ€ 2ëª…ì˜ ë¦¬ë·°ì–´
              });
              
              console.log(`âœ… PR #${prNumber}ì— ë¦¬ë·°ì–´ ìš”ì²­ ì™„ë£Œ: ${reviewers.join(', ')}`);
            } catch (error) {
              console.log(`âš ï¸ ë¦¬ë·°ì–´ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
            }
          } 