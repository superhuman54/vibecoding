name: ğŸ‘¤ ì´ìŠˆ ìë™ í• ë‹¹

on:
  issues:
    types: [opened, reopened]

jobs:
  assign-issue:
    name: ì´ìŠˆ ìë™ í• ë‹¹
    runs-on: ubuntu-latest
    
    steps:
    - name: ì´ìŠˆ ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.payload.issue.number;
          const title = context.payload.issue.title.toLowerCase();
          const body = context.payload.issue.body || '';
          const author = context.payload.issue.user.login;
          
          // ê¸°ë³¸ í• ë‹¹ì ì„¤ì • (ì €ì¥ì†Œ ì†Œìœ ì ë˜ëŠ” ë©”ì¸ ë©”ì¸í…Œì´ë„ˆ)
          const defaultAssignees = [owner];
          
          // ì´ìŠˆ íƒ€ì…ë³„ ë‹´ë‹¹ì ë§¤í•‘
          const issueOwners = {
            // ë°±ì—”ë“œ ê´€ë ¨
            'backend': ['backend-team', owner],
            'api': ['backend-team', owner],
            'fastapi': ['backend-team', owner],
            'server': ['backend-team', owner],
            'database': ['backend-team', owner],
            
            // í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨
            'frontend': ['frontend-team', owner],
            'ui': ['frontend-team', owner],
            'streamlit': ['frontend-team', owner],
            'interface': ['frontend-team', owner],
            
            // AI/Agent ê´€ë ¨
            'agent': ['ai-team', owner],
            'langgraph': ['ai-team', owner],
            'llm': ['ai-team', owner],
            'ai': ['ai-team', owner],
            'gemini': ['ai-team', owner],
            
            // ë¬¸ì„œ ê´€ë ¨
            'docs': ['docs-team', owner],
            'documentation': ['docs-team', owner],
            'readme': ['docs-team', owner],
            
            // ì¸í”„ë¼/ë°°í¬ ê´€ë ¨
            'deploy': ['devops-team', owner],
            'docker': ['devops-team', owner],
            'ci': ['devops-team', owner],
            'github': ['devops-team', owner],
            
            // í…ŒìŠ¤íŠ¸ ê´€ë ¨
            'test': ['qa-team', owner],
            'testing': ['qa-team', owner],
            'pytest': ['qa-team', owner],
            
            // ë³´ì•ˆ ê´€ë ¨
            'security': ['security-team', owner],
            'auth': ['security-team', owner],
            'vulnerability': ['security-team', owner]
          };
          
          let assignees = new Set(defaultAssignees);
          
          // ì œëª©ê³¼ ë‚´ìš©ì—ì„œ í‚¤ì›Œë“œ ê²€ìƒ‰í•˜ì—¬ ë‹´ë‹¹ì ê²°ì •
          const content = (title + ' ' + body).toLowerCase();
          
          for (const [keyword, owners] of Object.entries(issueOwners)) {
            if (content.includes(keyword)) {
              owners.forEach(owner => assignees.add(owner));
            }
          }
          
          // ì´ìŠˆ íƒ€ì…ë³„ ìš°ì„ ìˆœìœ„ í• ë‹¹
          let priority = 'medium';
          if (content.includes('critical') || content.includes('urgent') || content.includes('crash')) {
            priority = 'critical';
            // í¬ë¦¬í‹°ì»¬ ì´ìŠˆëŠ” ëª¨ë“  ê´€ë ¨ íŒ€ì— í• ë‹¹
            assignees.add(owner);
          } else if (content.includes('bug') || content.includes('error') || content.includes('fail')) {
            priority = 'high';
          } else if (content.includes('feature') || content.includes('enhancement')) {
            priority = 'medium';
          } else {
            priority = 'low';
          }
          
          // ì‘ì„±ìëŠ” í• ë‹¹ìì—ì„œ ì œì™¸
          assignees.delete(author);
          
          const finalAssignees = Array.from(assignees).slice(0, 3); // ìµœëŒ€ 3ëª…ê¹Œì§€ í• ë‹¹
          
          if (finalAssignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: finalAssignees
              });
              
              console.log(`âœ… Issue #${issueNumber}ì— í• ë‹¹ì ì¶”ê°€ ì™„ë£Œ: ${finalAssignees.join(', ')}`);
              
              // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ì¶”ê°€
              const priorityLabel = `priority/${priority}`;
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: [priorityLabel]
              });
              
              // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
              const comment = `## ğŸ‘¥ ë‹´ë‹¹ì ìë™ í• ë‹¹ ì™„ë£Œ

              ë‹¤ìŒ ë‹´ë‹¹ìë“¤ì´ ì´ ì´ìŠˆë¥¼ ê²€í† í•  ì˜ˆì •ì…ë‹ˆë‹¤:
              ${finalAssignees.map(assignee => `- @${assignee}`).join('\n')}
              
              **ìš°ì„ ìˆœìœ„:** \`${priority}\`
              
              **í• ë‹¹ ê·¼ê±°:**
              - ê¸°ë³¸ ë©”ì¸í…Œì´ë„ˆ: @${owner}
              ${Object.entries(issueOwners).map(([keyword, owners]) => {
                if (content.includes(keyword)) {
                  return `- "${keyword}" í‚¤ì›Œë“œ ê°ì§€: ${keyword} ì˜ì—­ ë‹´ë‹¹ì`;
                }
                return null;
              }).filter(Boolean).slice(0, 3).join('\n')}
              
              ### ğŸ“ ì—°ë½ ë°©ë²•
              - **ê¸´ê¸‰í•œ ê²½ìš°**: ë‹´ë‹¹ìë¥¼ ì§ì ‘ ë©˜ì…˜í•´ ì£¼ì„¸ìš”
              - **ì¶”ê°€ ì •ë³´ í•„ìš”**: ëŒ“ê¸€ë¡œ ìƒì„¸ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”
              - **ì§„í–‰ ìƒí™© í™•ì¸**: ì–¸ì œë“  ë¬¸ì˜í•´ ì£¼ì„¸ìš”
              
              ---
              _ìë™ìœ¼ë¡œ í• ë‹¹ëœ ë‹´ë‹¹ìì…ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤._`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: comment
              });
              
            } catch (error) {
              console.log(`âš ï¸ ì¼ë¶€ ì‚¬ìš©ìë¥¼ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
              
              // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ í• ë‹¹ìë§Œ í• ë‹¹ ì‹œë„
              try {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  assignees: [owner]
                });
                
                const fallbackComment = `## âš ï¸ ìë™ í• ë‹¹ ë¶€ë¶„ ì‹¤íŒ¨

                ì¼ë¶€ ë‹´ë‹¹ì í• ë‹¹ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, ê¸°ë³¸ ë©”ì¸í…Œì´ë„ˆ(@${owner})ê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.
                
                **ìˆ˜ë™ìœ¼ë¡œ ì ì ˆí•œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”:**
                - ë°±ì—”ë“œ ì´ìŠˆ: \`@backend-team\`
                - í”„ë¡ íŠ¸ì—”ë“œ ì´ìŠˆ: \`@frontend-team\`  
                - AI/Agent ì´ìŠˆ: \`@ai-team\`
                - ë¬¸ì„œ ì´ìŠˆ: \`@docs-team\`
                - ì¸í”„ë¼ ì´ìŠˆ: \`@devops-team\`
                
                ---
                _ìë™ í• ë‹¹ ì‹œìŠ¤í…œì—ì„œ ìƒì„±ëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤._`;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: fallbackComment
                });
                
              } catch (fallbackError) {
                console.log(`âŒ ê¸°ë³¸ í• ë‹¹ì í• ë‹¹ë„ ì‹¤íŒ¨: ${fallbackError.message}`);
                
                const errorComment = `## âŒ ìë™ í• ë‹¹ ì‹¤íŒ¨

                ìë™ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”.
                
                **ì´ìŠˆ íƒ€ì…ë³„ ê¶Œì¥ ë‹´ë‹¹ì:**
                - ğŸ”§ ë°±ì—”ë“œ: \`@backend-team\`
                - ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ: \`@frontend-team\`
                - ğŸ¤– AI/Agent: \`@ai-team\`
                - ğŸ“š ë¬¸ì„œ: \`@docs-team\`
                - âš™ï¸ ì¸í”„ë¼: \`@devops-team\`
                - ğŸ§ª í…ŒìŠ¤íŠ¸: \`@qa-team\`
                - ğŸ”’ ë³´ì•ˆ: \`@security-team\`
                
                ---
                _ìë™ í• ë‹¹ ì‹¤íŒ¨ ì•Œë¦¼ì…ë‹ˆë‹¤._`;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: errorComment
                });
              }
            }
          }

  notify-urgent-issues:
    name: ê¸´ê¸‰ ì´ìŠˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'urgent') || contains(github.event.issue.title, 'critical') || contains(github.event.issue.body, 'urgent') || contains(github.event.issue.body, 'critical')
    
    steps:
    - name: ê¸´ê¸‰ ì´ìŠˆ íŠ¹ë³„ ì²˜ë¦¬
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.payload.issue.number;
          const title = context.payload.issue.title;
          const author = context.payload.issue.user.login;
          
          // ê¸´ê¸‰ ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            owner,
            repo,
            issue_number: issueNumber,
            labels: ['priority/critical', 'urgent']
          });
          
          // ê¸´ê¸‰ ì´ìŠˆ ì•Œë¦¼ ëŒ“ê¸€
          const urgentComment = `## ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ ê°ì§€ë¨

          ì´ ì´ìŠˆëŠ” **ê¸´ê¸‰(Critical)** ìš°ì„ ìˆœìœ„ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### â° ê¸´ê¸‰ ì²˜ë¦¬ ì ˆì°¨
          
          1. **ì¦‰ì‹œ ê²€í† ** (30ë¶„ ì´ë‚´): ë©”ì¸í…Œì´ë„ˆê°€ ì¦‰ì‹œ í™•ì¸
          2. **ë¹ ë¥¸ íŠ¸ë¦¬ì•„ì§€** (1ì‹œê°„ ì´ë‚´): ê¸°ìˆ ì  ë¶„ì„ ë° ë¶„ë¥˜
          3. **ê¸´ê¸‰ í• ë‹¹** (2ì‹œê°„ ì´ë‚´): ìµœìš°ì„  ë‹´ë‹¹ì ë°°ì •
          4. **ìƒíƒœ ì—…ë°ì´íŠ¸** (4ì‹œê°„ ì´ë‚´): ì§„í–‰ ìƒí™© ë° í•´ê²° ë°©ì•ˆ ê³µìœ 
          
          ### ğŸ“ ê¸´ê¸‰ ì—°ë½ì²˜
          
          - **í”„ë¡œì íŠ¸ ë©”ì¸í…Œì´ë„ˆ**: @${owner}
          - **ê¸°ìˆ  ë¦¬ë“œ**: ì¦‰ì‹œ ë©˜ì…˜ìœ¼ë¡œ ì—°ë½
          - **ì¶”ê°€ ë„ì›€**: ì´ ëŒ“ê¸€ì— ë‹µê¸€ë¡œ ìƒí™© ì„¤ëª…
          
          ### âœ… ê¸°ëŒ€ ì‘ë‹µ ì‹œê°„
          
          - **ì²« ì‘ë‹µ**: 30ë¶„ ì´ë‚´
          - **ìƒí™© ë¶„ì„**: 1ì‹œê°„ ì´ë‚´  
          - **í•´ê²° ë°©ì•ˆ**: 4ì‹œê°„ ì´ë‚´
          - **ì™„ì „ í•´ê²°**: ê¸´ê¸‰ë„ì— ë”°ë¼ 24ì‹œê°„ ì´ë‚´
          
          @${owner} ê¸´ê¸‰ ì´ìŠˆê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸš¨
          
          ---
          _ê¸´ê¸‰ ì´ìŠˆ ìë™ ì•Œë¦¼ ì‹œìŠ¤í…œì…ë‹ˆë‹¤._`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: urgentComment
          }); 