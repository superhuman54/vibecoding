name: ğŸ” PR ìë™ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  automated-review:
    name: ìë™ ì½”ë“œ ë¦¬ë·°
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ì½”ë“œ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy bandit safety
        
    - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (Black)
      id: black-check
      run: |
        echo "ğŸ¨ Black ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì¤‘..."
        black_output=$(black --check --diff . 2>&1 || true)
        echo "black_result<<EOF" >> $GITHUB_OUTPUT
        echo "$black_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
      id: isort-check
      run: |
        echo "ğŸ“¦ Import ì •ë ¬ ê²€ì‚¬ ì¤‘..."
        isort_output=$(isort --check-only --diff . 2>&1 || true)
        echo "isort_result<<EOF" >> $GITHUB_OUTPUT
        echo "$isort_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Flake8)
      id: flake8-check
      run: |
        echo "ğŸ” Flake8 ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
        flake8_output=$(flake8 --max-line-length=88 --extend-ignore=E203,W503 . 2>&1 || true)
        echo "flake8_result<<EOF" >> $GITHUB_OUTPUT
        echo "$flake8_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: íƒ€ì… ê²€ì‚¬ (MyPy)
      id: mypy-check
      run: |
        echo "ğŸ·ï¸ MyPy íƒ€ì… ê²€ì‚¬ ì¤‘..."
        mypy_output=$(mypy --ignore-missing-imports . 2>&1 || true)
        echo "mypy_result<<EOF" >> $GITHUB_OUTPUT
        echo "$mypy_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ë³´ì•ˆ ê²€ì‚¬ (Bandit)
      id: bandit-check
      run: |
        echo "ğŸ”’ Bandit ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
        bandit_output=$(bandit -r . -f json 2>&1 || true)
        echo "bandit_result<<EOF" >> $GITHUB_OUTPUT
        echo "$bandit_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ (Safety)
      id: safety-check
      run: |
        echo "ğŸ›¡ï¸ Safety ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
        cd backend
        safety_output=$(safety check --json 2>&1 || true)
        echo "safety_result<<EOF" >> $GITHUB_OUTPUT
        echo "$safety_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€ ì‘ì„±
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          
          const blackResult = `${{ steps.black-check.outputs.black_result }}`;
          const isortResult = `${{ steps.isort-check.outputs.isort_result }}`;
          const flake8Result = `${{ steps.flake8-check.outputs.flake8_result }}`;
          const mypyResult = `${{ steps.mypy-check.outputs.mypy_result }}`;
          const banditResult = `${{ steps.bandit-check.outputs.bandit_result }}`;
          const safetyResult = `${{ steps.safety-check.outputs.safety_result }}`;
          
          let reviewComment = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n`;
          let hasIssues = false;
          
          // Black ê²°ê³¼ ë¶„ì„
          if (blackResult && blackResult.includes('would reformat')) {
            hasIssues = true;
            reviewComment += `### ğŸ¨ ì½”ë“œ í¬ë§·íŒ… (Black)\n`;
            reviewComment += `âŒ **ìˆ˜ì • í•„ìš”**: ì¼ë¶€ íŒŒì¼ì˜ í¬ë§·íŒ…ì´ í‘œì¤€ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.\n`;
            reviewComment += `\`\`\`\n${blackResult.substring(0, 1000)}\`\`\`\n\n`;
          } else {
            reviewComment += `### ğŸ¨ ì½”ë“œ í¬ë§·íŒ… (Black)\nâœ… **í†µê³¼**: ëª¨ë“  íŒŒì¼ì´ ì˜¬ë°”ë¥´ê²Œ í¬ë§·íŒ…ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // isort ê²°ê³¼ ë¶„ì„
          if (isortResult && isortResult.includes('ERROR')) {
            hasIssues = true;
            reviewComment += `### ğŸ“¦ Import ì •ë ¬ (isort)\n`;
            reviewComment += `âŒ **ìˆ˜ì • í•„ìš”**: Import ë¬¸ì˜ ì •ë ¬ì´ í‘œì¤€ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.\n`;
            reviewComment += `\`\`\`\n${isortResult.substring(0, 1000)}\`\`\`\n\n`;
          } else {
            reviewComment += `### ğŸ“¦ Import ì •ë ¬ (isort)\nâœ… **í†µê³¼**: Import ë¬¸ì´ ì˜¬ë°”ë¥´ê²Œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // Flake8 ê²°ê³¼ ë¶„ì„
          if (flake8Result && flake8Result.trim() && !flake8Result.includes('no issues found')) {
            hasIssues = true;
            reviewComment += `### ğŸ” ì½”ë“œ í’ˆì§ˆ (Flake8)\n`;
            reviewComment += `âŒ **ìˆ˜ì • í•„ìš”**: ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
            reviewComment += `\`\`\`\n${flake8Result.substring(0, 1000)}\`\`\`\n\n`;
          } else {
            reviewComment += `### ğŸ” ì½”ë“œ í’ˆì§ˆ (Flake8)\nâœ… **í†µê³¼**: ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // MyPy ê²°ê³¼ ë¶„ì„
          if (mypyResult && mypyResult.includes('error')) {
            reviewComment += `### ğŸ·ï¸ íƒ€ì… ê²€ì‚¬ (MyPy)\n`;
            reviewComment += `âš ï¸ **ì£¼ì˜**: íƒ€ì… ê´€ë ¨ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
            reviewComment += `\`\`\`\n${mypyResult.substring(0, 1000)}\`\`\`\n\n`;
          } else {
            reviewComment += `### ğŸ·ï¸ íƒ€ì… ê²€ì‚¬ (MyPy)\nâœ… **í†µê³¼**: íƒ€ì… ê´€ë ¨ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // Bandit ê²°ê³¼ ë¶„ì„
          try {
            const banditJson = JSON.parse(banditResult);
            if (banditJson.results && banditJson.results.length > 0) {
              hasIssues = true;
              reviewComment += `### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)\n`;
              reviewComment += `âŒ **ë³´ì•ˆ ì´ìŠˆ ë°œê²¬**: ${banditJson.results.length}ê°œì˜ ì ì¬ì  ë³´ì•ˆ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
              banditJson.results.slice(0, 3).forEach((issue, index) => {
                reviewComment += `${index + 1}. **${issue.test_name}** (${issue.severity}): ${issue.filename}:${issue.line_number}\n`;
              });
              reviewComment += `\n`;
            } else {
              reviewComment += `### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)\nâœ… **í†µê³¼**: ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
            }
          } catch (e) {
            reviewComment += `### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)\nâš ï¸ **ê²€ì‚¬ ì‹¤íŒ¨**: ë³´ì•ˆ ê²€ì‚¬ë¥¼ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // Safety ê²°ê³¼ ë¶„ì„
          try {
            const safetyJson = JSON.parse(safetyResult);
            if (safetyJson && safetyJson.length > 0) {
              hasIssues = true;
              reviewComment += `### ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ (Safety)\n`;
              reviewComment += `âŒ **ì·¨ì•½ì  ë°œê²¬**: ${safetyJson.length}ê°œì˜ ì˜ì¡´ì„± ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
              safetyJson.slice(0, 3).forEach((vuln, index) => {
                reviewComment += `${index + 1}. **${vuln.package_name}** ${vuln.installed_version}: ${vuln.advisory}\n`;
              });
              reviewComment += `\n`;
            } else {
              reviewComment += `### ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ (Safety)\nâœ… **í†µê³¼**: ì˜ì¡´ì„± ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
            }
          } catch (e) {
            reviewComment += `### ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ (Safety)\nâœ… **í†µê³¼**: ì˜ì¡´ì„± ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n`;
          }
          
          // ì¢…í•© ê²°ê³¼
          if (hasIssues) {
            reviewComment += `## ğŸ“‹ ì¢…í•© ê²°ê³¼\n\n`;
            reviewComment += `âŒ **ìˆ˜ì •ì´ í•„ìš”í•œ ì´ìŠˆë“¤ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.** ìœ„ì˜ ê¶Œì¥ì‚¬í•­ì„ ì°¸ê³ í•˜ì—¬ ì½”ë“œë¥¼ ê°œì„ í•´ ì£¼ì„¸ìš”.\n\n`;
            reviewComment += `### ğŸ› ï¸ ìˆ˜ì • ë°©ë²•\n`;
            reviewComment += `\`\`\`bash\n`;
            reviewComment += `# ì½”ë“œ í¬ë§·íŒ… ìë™ ìˆ˜ì •\n`;
            reviewComment += `black .\n`;
            reviewComment += `isort .\n\n`;
            reviewComment += `# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬\n`;
            reviewComment += `flake8 .\n\n`;
            reviewComment += `# ë³´ì•ˆ ê²€ì‚¬\n`;
            reviewComment += `bandit -r .\n`;
            reviewComment += `\`\`\`\n`;
          } else {
            reviewComment += `## ğŸ‰ ì¢…í•© ê²°ê³¼\n\n`;
            reviewComment += `âœ… **í›Œë¥­í•©ë‹ˆë‹¤!** ëª¨ë“  ìë™ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì½”ë“œê°€ í”„ë¡œì íŠ¸ í‘œì¤€ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n`;
          }
          
          reviewComment += `---\n_ìë™ìœ¼ë¡œ ìƒì„±ëœ ì½”ë“œ ë¦¬ë·°ì…ë‹ˆë‹¤. ì¶”ê°€ ì§ˆë¬¸ì´ë‚˜ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ ì£¼ì„¸ìš”!_`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: prNumber,
            body: reviewComment
          }); 